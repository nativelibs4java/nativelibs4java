#!/bin/bash
MVN_VERSION="`cat pom.xml | grep '<version' | head -n 1 | sed -e 's/.*<version>\(.*\)<\/version>.*/\1/g'`"
SBAZ_VERSION="`echo $MVN_VERSION | sed -e "s/-SNAPSHOT/-SNAPSHOT-\`date '+%Y%m%d'\`/g"`"
#LINK_BASE="http://nativelibs4java.sourceforge.net/sbaz/scalacl/"
LINK_BASE="http://ochafik.com/sbaz/scalacl/"

SCALACL_HOME="`pwd`"

echo "###################################################"
echo "# ScalaCL : "
echo "#     Maven version = $MVN_VERSION"
echo "#      sbaz version = $SBAZ_VERSION"
echo "###################################################"

mvn -Djarsigner.skip=false -Dstorepass=$KEYSTORE_PASS package -DskipTests                    

cd ../ScalaCLPlugin
mvn -Djarsigner.skip=false -Dstorepass=$KEYSTORE_PASS package -DskipTests
cd $SCALACL_HOME


TEMP_OUT=target/sbaz_out
LIB_JAR_OUT=$TEMP_OUT/lib
PLUGIN_JAR_OUT=$TEMP_OUT/misc/scala-devel/plugins

rm -fR $TEMP_OUT

mkdir -p $LIB_JAR_OUT
mkdir -p $PLUGIN_JAR_OUT

if [[ "$USE_SHADED" == "1" ]] ; then
	cp target/scalacl-$MVN_VERSION-shaded.jar $LIB_JAR_OUT ;
else
	NL4J_BASE="/Users/ochafik/.m2/repository/com/nativelibs4java"
	cp target/scalacl-$MVN_VERSION.jar $LIB_JAR_OUT
	cp $NL4J_BASE/bridj/0.3-SNAPSHOT/bridj-0.3-SNAPSHOT-shaded.jar $LIB_JAR_OUT
	cp $NL4J_BASE/opencl4java-bridj/1.0-SNAPSHOT/opencl4java-bridj-1.0-SNAPSHOT.jar $LIB_JAR_OUT
	cp $NL4J_BASE/javacl-core-bridj/1.0-SNAPSHOT/javacl-core-bridj-1.0-SNAPSHOT.jar $LIB_JAR_OUT
	cp $NL4J_BASE/javacl-bridj/1.0-SNAPSHOT/javacl-bridj-1.0-SNAPSHOT.jar $LIB_JAR_OUT
	cp $NL4J_BASE/libcl-bridj/1.0-SNAPSHOT/libcl-bridj-1.0-SNAPSHOT.jar $LIB_JAR_OUT ;
fi

echo "Copied the following libraries :"
ls -l $LIB_JAR_OUT

cp ../ScalaCLPlugin/target/scalacl-compiler-plugin-$MVN_VERSION.jar $PLUGIN_JAR_OUT

sbaz pack scalacl $TEMP_OUT \
	--linkbase $LINK_BASE \
	--version $SBAZ_VERSION \
	--outdir src/main/sbaz \
	--descfile ABOUT

mkdir -p src/main/sbaz

sbaz remove scalacl
sbaz compact
#sbaz retract scalacl/$SBAZ_VERSION
if [[ "$SHARE" == "1" ]] ; then
	sbaz share *.advert ;
else 
	echo "Not sharing the package (use SHARE=1 to share)"
	echo src/main/sbaz/scalacl-$SBAZ_VERSION.sbp ;
fi
mv *.advert src/main/sbaz
open src/main/sbaz
